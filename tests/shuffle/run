/*
 * Nibble - Concurrent Log-Structured Memory for Many-Core Key-Value Stores
 *
 * (c) 2017 Hewlett Packard Enterprise Development LP.
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the
 * GNU Lesser General Public License as published by the Free Software Foundation, either version 3
 * of the License, or (at your option) any later version. This program is distributed in the hope that
 * it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License along with this program.
 * If not, see <http://www.gnu.org/licenses/>. As an exception, the copyright holders of this Library
 * grant you permission to (i) compile an Application with the Library, and (ii) distribute the Application
 * containing code generated by the Library and added to the Application during this compilation process
 * under terms of your choice, provided you also meet the terms and conditions of the Application license.
 */


#! /usr/bin/env bash
set -e
set -u

SOCKETS=16
CPUSPER=18
PAIRSPER=$(($CPUSPER/2))

[[ ! -d oldlogs ]] && \
    mkdir -v -p oldlogs

mv -vfbu -t oldlogs *.log || true

../../scripts/sysinfo > sysinfo.log

for b in 1024; do
    for ((s=1; s<=$SOCKETS; s++)); do
        pairs=$(($s*$PAIRSPER))
        echo ''; echo ''
        echo "# run: b $b s $s pairs $pairs"
        echo "NIBDEBUG=3 ./shuffle $pairs $b"
        NIBDEBUG=3 ./shuffle $pairs $b \
            2>&1 | tee -a b.${b}.log
        sync
        sleep 10 
    done
done
